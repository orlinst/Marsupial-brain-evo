---
title: "Marsupial Brain Analyses"
author: "Orlin Todorov"
date: "15 January 2019"
output: 
  html_document: 
    fig_caption: yes
    fig_height: 8
    fig_width: 10
---

#SURFACE
```{r setup, include=FALSE}

install.packages('caper')
install.packages('surface')
install.packages('igraph')

require(caper)
library(surface)
library(igraph)


#load surface data - already ln'ed, stdzed, res included
load("./Data/data_surface.txt")
load("./Data/surface_standartized_res_body.RData")
tree <-read.tree("./Data/tree176.nwk")


#OPTION 1#

surface <- runSurface(tree, dat, exclude = 0, aic_threshold = 0, max_steps = NULL,
  verbose = FALSE, plotaic = FALSE, error_skip = FALSE, only_best = FALSE,
  sample_shifts=FALSE, sample_threshold = 2)


kk<-length(surface$bwd)
surfaceTreePlot(tree, surface$bwd[[kk]], labelshifts = T, convcol = TRUE, cex = 0.5, align.tip.label = T)
surfaceTraitPlot(dat, surface$bwd[[kk]], whattraits = c(1,2))

bsum<-surfaceSummary(surface$bwd)
bsum$alpha
bsum$sigma_squared
bsum$theta
bsum$n_regimes

surfaceSummary(surface$fwd, surface$bwd)

surfaceAICPlot(surface$fwd, surface$bwd)


###
#sigma2	Rate of stochastic evolution (one parameter per trait)
# alpha	Rate of adaptation to optima (one parameter per trait)
# t 1/2	Expected time to evolve halfway to an optimum; log(2)/??
# theta	Optimum trait value (one parameter per regime per trait)
# k	Number of regime shifts
# k'	Number of distinct regimes (after collapsing convergent regimes)
# k'conv	Number of convergent regimes reached by multiple shifts
# delta k	k ??? k', the reduction in complexity of the adaptive landscape when accounting for convergence
# delta k/k	Relative reduction in complexity of the adaptive landscape when accounting for convergence
# c	Number of shifts that are towards convergent regimes occupied by multiple lineages
# c/k	Proportion of shifts that are towards convergent regimes


#node desccentands by numbers
require(phangorn)
Descendants(tree,node=198, type ="all")

#find node descendants by labels
tips(tree, node)

#identify node by clicking close to it
identify(tree, nodes = TRUE, tips = FALSE, labels = TRUE, quiet = FALSE)

#plot edges/nodes/tips
plot(tree)
edgelabels(tree$edge, c(1, 2, 198), frame = "none", col = "red")

options(max.print=10000)

#USE THIS ONE
ouchDescendants(78, otree)


#OPTION 2#

tree<-nameNodes(tree)
olist<-convertTreeData(tree,dat)
otree<-olist[[1]]; odata<-olist[[2]]
fwd<-surfaceForward(otree, odata, aic_threshold = 0, exclude = 0, verbose = TRUE, plotaic = TRUE, save_steps=TRUE)




k<-length(fwd)
fsum<-surfaceSummary(fwd)
names(fsum)


bwd<-surfaceBackward(otree, odata, starting_model = fwd[[k]], aic_threshold = 0, only_best = TRUE, verbose = FALSE, plotaic = FALSE)
bsum<-surfaceSummary(bwd)
kk<-length(bwd)

surfaceTreePlot(tree, bwd[[kk]], labelshifts = T)

par(mfrow=c(1,2), mai=c(0.8,0.8,0.2,0.2))
surfaceTraitPlot(dat, bwd[[kk]], whattraits = c(1,2))

bm<-startingModel(otree,odata,brownian=TRUE)
ou1<-startingModel(otree,odata)
surfaceAICPlot(fwd, bwd)
abline(h=bm[[1]]$aic,lty="longdash")
abline(h=H12[[1]]$aic,lty="longdash")
text(c(6,6),c(bm[[1]]$aic, ou1[[1]]$aic, H12[[1]]$aic)-2,c("BM","OU1","H12"),cex=0.5)





```